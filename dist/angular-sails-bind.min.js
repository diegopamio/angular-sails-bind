/*! angular-sails-bind - v1.0.5 - 2014-10-15
* https://github.com/diegopamio/angular-sails-bind
* Copyright (c) 2014 Diego Pamio; Licensed MIT */
function diff(a,b){return a.filter(function(a){return b.indexOf(a)<0})}var app=angular.module("ngSailsBind",[]);app.factory("$sailsBind",["$q","$rootScope","$timeout","$log",function(a,b,c,d){"use strict";var e=function(e,h,i,j){function k(a){var b=h[e+"s"],f={created:function(){return h[e+"s"].push(a.data),!0},updated:function(){var c=b.find(function(b){return a.id==b.id});return c?(angular.extend(c,a.data),!0):!1},destroyed:function(){var c=b.find(function(b){return a.id==b.id});return c?(b.splice(b.indexOf(c),1),!0):!1}};f[a.verb]?f[a.verb]()&&c(function(){h.$apply()}):d.log("Unknown action »"+a.verb+"«")}function l(){h.$watchCollection(e+"s",function(a,c){var d,i;a=a||[],c=c||[],d=diff(a,c),i=diff(c,a),i.forEach(function(a){g("/"+m+e+"?id="+a.id).then(function(c){c&&!c.error&&(b.$broadcast(e,{id:a.id,verb:"destroyed",scope:h.$id}),io.socket.delete("/"+m+e+"/destroy/"+a.id))})}),d.forEach(function(a){a.id||io.socket.put("/"+m+e+"/create/",a,function(c){g("/"+m+e+"/"+c.id).then(function(c){angular.extend(a,c),b.$broadcast(e,{id:a.id,verb:"created",scope:h.$id,data:angular.copy(a)})})})}),f(d,h,e,m)})}var m=e.split("/");m.length>1?(e=m.splice(m.length-1,1),m=m.join("/")+"/"):m="";var n=new a.defer,o=g("/"+m+e,i);return o.then(function(a){Array.isArray(a)||(a=[a]),h[e+"s"]=a,f(a,h,e,m),j(),l(),n.resolve()}),io.socket.on(e,k),h.$on(e,function(a,b){h.$id!=b.scope&&k(b)}),n.promise},f=function(a,c,d,e){a.forEach(function(a){c.$watchCollection(d+"s["+c[d+"s"].indexOf(a)+"]",function(a,f){f&&a&&(angular.equals(f,a)||f.id!=a.id||f.updatedAt!==a.updatedAt||(b.$broadcast(d,{id:f.id,verb:"updated",scope:c.$id,data:angular.extend(angular.copy(a),{updatedAt:(new Date).toISOString()})}),io.socket.post("/"+e+d+"/update/"+f.id,angular.copy(a))))})})},g=function(c,d){var e=new a.defer;return d=d||{},io.socket.get(c,d,function(a){b.$apply(e.resolve(a))}),e.promise};return{bind:e}}]),Array.prototype.find||Object.defineProperty(Array.prototype,"find",{enumerable:!1,configurable:!0,writable:!0,value:function(a){if(null==this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof a)throw new TypeError("predicate must be a function");for(var b,c=Object(this),d=c.length>>>0,e=arguments[1],f=0;d>f;f++)if(f in c&&(b=c[f],a.call(e,b,f,c)))return b;return void 0}}),Array.isArray||(Array.isArray=function(a){return"[object Array]"===Object.prototype.toString.call(a)});